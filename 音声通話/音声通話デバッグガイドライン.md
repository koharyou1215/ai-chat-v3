現在の問題を分析すると、WebSocket接続は成功しているものの、音声処理パイプラインのどこかで処理が止まっている状況ですね。2,855件ものメッセージが送信されているということは、音声データは正常に送信されているが、サーバー側の処理に問題があると考えられます。

## 問題の診断と解決策## 問題の診断結果と解決策
# 音声通話機能 トラブルシューティングガイド

## 🔍 現在の問題分析

### 症状
- WebSocket接続は成功（2,855件のメッセージ受信）
- 音声データは送信されている
- しかし音声が再生されない
- サーバーからの応答がない

### 根本原因の可能性

#### 1. **VAD（音声活動検知）の問題** ⭐最も可能性が高い
元のコードでは`node-vad`を使用していましたが、これが正しくインストール/動作していない可能性があります。

**解決策:**
```javascript
// voice-server-debug.js の簡易VADを使用
calculateAudioLevel(audioData) {
  let sum = 0;
  for (let i = 0; i < audioData.length; i += 2) {
    const sample = audioData.readInt16LE(i);
    sum += Math.abs(sample) / 32768.0;
  }
  return sum / (audioData.length / 2);
}
```

#### 2. **OpenAI APIキーの設定問題**
環境変数が正しく読み込まれていない可能性があります。

**確認方法:**
```bash
# .env.localの確認
cat .env.local | grep OPENAI_API_KEY

# サーバー起動時に環境変数を確認
node -e "require('dotenv').config({path:'.env.local'}); console.log(process.env.OPENAI_API_KEY ? 'APIキー設定済み' : 'APIキー未設定')"
```

#### 3. **音声データフォーマットの問題**
クライアントとサーバーで音声フォーマットが一致していない。

**解決策:**
- サンプルレート: 16000Hz
- チャンネル数: 1（モノラル）
- ビット深度: 16bit
- エンディアン: リトルエンディアン

#### 4. **非同期処理のエラー**
エラーが握りつぶされている可能性があります。

## 🛠️ 段階的な診断手順

### ステップ1: 基本的な接続確認

```bash
# 1. VOICEVOXの起動確認
curl http://127.0.0.1:50021/speakers
# スピーカー一覧が返ってくればOK

# 2. 音声サーバーの起動（デバッグ版を使用）
node voice-server-debug.js
# ログを確認

# 3. ヘルスチェック
curl http://localhost:8082/health
```

### ステップ2: テストコンポーネントの使用

1. `VoiceCallTest.tsx`をプロジェクトに追加
2. ページに配置して段階的にテスト

```tsx
// src/app/test/page.tsx
import { VoiceCallTest } from '@/components/voice/VoiceCallTest';

export default function TestPage() {
  return <VoiceCallTest />;
}
```

3. 各機能を個別にテスト
   - WebSocket接続テスト
   - VOICEVOXダイレクトテスト
   - マイクテスト
   - 録音・送信テスト

### ステップ3: ログの確認

**サーバー側のログで確認すべき項目:**
```
[CONFIG] Server configuration: { hasOpenAIKey: true/false, ... }
[VOICEVOX] Connection successful
[WS] New connection: <sessionId>
[AUDIO] Speech started/ended
[STT] Recognized: "..."
[AI] Response: "..."
[TTS] Synthesizing: "..."
[STREAM] Progress: ...%
```

**問題のパターンと対処法:**

| ログパターン | 問題 | 対処法 |
|------------|------|--------|
| `Speech started`が出ない | VADが機能していない | 音声レベルの閾値を調整 |
| `STT Error` | OpenAI APIの問題 | APIキーを確認、モック使用 |
| `VOICEVOX Error` | 音声合成失敗 | VOICEVOXの起動確認 |
| `Stream completed`が出ない | 送信処理の問題 | WebSocket状態を確認 |

## 🚀 即効性のある解決策

### 1. 最小構成での動作確認

```javascript
// test-minimal.js
const WebSocket = require('ws');
const axios = require('axios');

// 最小限のテストサーバー
const wss = new WebSocket.Server({ port: 8082 });

wss.on('connection', async (ws) => {
  console.log('Connected!');
  
  // すぐにテスト音声を送信
  try {
    const response = await axios.post(
      'http://127.0.0.1:50021/audio_query?speaker=1',
      'テストです',
      { headers: { 'Content-Type': 'application/json' } }
    );
    
    const audio = await axios.post(
      'http://127.0.0.1:50021/synthesis?speaker=1',
      response.data,
      { responseType: 'arraybuffer' }
    );
    
    ws.send(Buffer.from(audio.data), { binary: true });
    console.log('Test audio sent!');
  } catch (error) {
    console.error('Error:', error.message);
  }
});

console.log('Test server running on 8082');
```

### 2. パッケージの再インストール

```bash
# 問題のあるパッケージを削除
npm uninstall node-vad

# 必要最小限のパッケージのみインストール
npm install ws express axios dotenv

# OpenAI（オプション）
npm install openai
```

### 3. プロセスの完全リセット

```powershell
# PowerShellで実行
# すべてのNode.jsプロセスを終了
Get-Process node | Stop-Process -Force

# ポートを解放
netstat -ano | findstr :8082
# PIDを確認して終了
Stop-Process -Id <PID> -Force

# キャッシュクリア
Remove-Item -Path '.next' -Recurse -Force
Remove-Item -Path 'node_modules/.cache' -Recurse -Force
```

## 📊 期待される動作フロー

1. **クライアント** → マイクから音声取得
2. **クライアント** → 音声データをWebSocketで送信
3. **サーバー** → 音声レベル検出（VAD代替）
4. **サーバー** → 発話終了検出（500ms無音）
5. **サーバー** → 音声認識（Whisper/モック）
6. **サーバー** → テキスト応答生成（GPT/モック）
7. **サーバー** → 音声合成（VOICEVOX）
8. **サーバー** → 音声データをチャンク送信
9. **クライアント** → 音声データ受信・再生

## ✅ 動作確認チェックリスト

- [ ] VOICEVOXが起動している（http://127.0.0.1:50021/speakers でレスポンス）
- [ ] voice-server-debug.jsが起動している
- [ ] .env.localにAPIキーが設定されている（オプション）
- [ ] ブラウザでマイク許可している
- [ ] WebSocket接続が確立されている
- [ ] 音声データが送信されている（ログで確認）
- [ ] サーバーで音声処理が実行されている（ログで確認）
- [ ] 音声データが返送されている（ログで確認）
- [ ] クライアントで音声が再生されている

## 🔧 推奨される次のステップ

1. **voice-server-debug.js**を使用して詳細なログを確認
2. **VoiceCallTest.tsx**で段階的にテスト
3. ログから具体的なエラー箇所を特定
4. 該当箇所のコードを修正
5. 最小構成から徐々に機能を追加

## 💡 Tips

- OpenAI APIキーがなくても、モック機能で基本的な動作確認は可能
- VOICEVOXの代わりにブラウザのWeb Speech APIも使用可能
- デバッグ時は`DEBUG=true`でより詳細なログを出力
- ネットワークタブでWebSocketのフレームを確認すると問題が見つかりやすい

現在の状況を分析すると、**音声データは正常に送信されているが、サーバー側の音声処理パイプラインで処理が止まっている**ことが原因と考えられます。

### 🎯 最も可能性の高い原因

1. **VAD（音声活動検知）が機能していない** - `node-vad`のインストールや初期化に失敗
2. **OpenAI APIキーが環境変数から読み込まれていない** - 音声認識でエラー
3. **エラーが握りつぶされている** - try-catchでエラーが隠蔽されている

### 🚀 即座に試すべき解決策

提供したコードには以下の改善が含まれています：

#### 1. **デバッグ機能強化版サーバー（voice-server-debug.js）**
- 詳細なログ出力で問題箇所を特定
- VADの代替実装（node-vadに依存しない）
- モック機能（OpenAI APIキーなしでも動作確認可能）
- ヘルスチェックエンドポイント

#### 2. **段階的テストコンポーネント（VoiceCallTest.tsx）**
- 各機能を個別にテスト可能
- リアルタイムログ表示
- 問題の切り分けが容易

#### 3. **最小構成での動作確認**
```bash
# 1. デバッグサーバーを起動
node voice-server-debug.js

# 2. ログを確認（特に以下の項目）
# - [CONFIG] hasOpenAIKey: true/false
# - [VOICEVOX] Connection successful
# - [AUDIO] Speech started/ended
# - [PROCESS] Processing utterance

# 3. ヘルスチェック
curl http://localhost:8082/health
```

### 📋 今すぐ実行すべきステップ

1. **既存のサーバーを停止して、デバッグ版を起動**
```powershell
# すべてのNode.jsプロセスを終了
Get-Process node | Stop-Process -Force

# デバッグ版を起動
node voice-server-debug.js
```

2. **テストコンポーネントで段階的に確認**
- WebSocket接続テスト → VOICEVOXダイレクトテスト → マイクテスト → 録音テスト

3. **ログから問題箇所を特定**
- 「Speech started」が出ない → VADの閾値を調整（0.01→0.005など）
- 「STT Error」が出る → OpenAI APIキーを確認、またはモックモードを使用
- 「VOICEVOX Error」が出る → VOICEVOXの起動を確認

### 🔑 成功への近道

**まず最小構成で音声が返ってくることを確認してから、徐々に機能を追加する**のが確実です。デバッグ版サーバーには、WebSocket接続直後にテスト音声を送る機能があるので、これで基本的な疎通確認ができます。

2,855件のメッセージが送信されているということは、音声データの送信自体は成功しているので、サーバー側の処理を修正すれば必ず動作するはずです。