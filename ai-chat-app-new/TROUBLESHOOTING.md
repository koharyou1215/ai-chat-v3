# AI Chat V3 トラブルシューティング

このドキュメントは、開発中によくある問題と解決方法をまとめています。

## 🔧 開発サーバー運用

### サーバー運用コマンド

```bash
# プロセス確認
netstat -ano | findstr :3000

# プロセス停止
powershell "Stop-Process -Id [PID] -Force"

# キャッシュクリア＆再起動
powershell "Remove-Item -Recurse -Force .next -ErrorAction SilentlyContinue"
npm run dev
```

### 重要な注意事項

- **ポート3000固定**: ユーザー環境では3000以外のポートでサーバー起動禁止
- **サーバー停止に注意**: 一度サーバーを停止すると再起動に非常に長い時間を要する
- **Hot Reload優先**: コード修正はHot Reloadで反映させ、可能な限りサーバーを停止しない
- **.nextキャッシュクリア**: 再起動には相当な時間を要する

## 💬 チャット機能の不具合対応

### 症状
- メニューが非表示になる
- 再生成・続き生成が反応しない
- チャットメニューが消える

### 原因
生成状態（`is_generating`/`group_generating`）が永続的にtrueになっている

### 解決方法

#### 1. 自動修復（推奨）
生成状態が30秒継続すると自動的にリセットされ、画面に通知が表示されます。

#### 2. 手動修復
1. **メッセージエリアをダブルクリック** → 「✅ 生成状態をリセットしました」表示
2. ページをリロード（F5）
3. サーバー再起動（最終手段）

### 短縮入力
「チャット見てください」と入力すると、Claudeがチャット機能の状態を確認します。

## 🔧 既知のビルドエラー対応（修正済み）

以下のエラーはすべて**修正済み**です。参考情報として残しています。

### BOMエラー
- **ファイル**: `kusuguri.json`と`いじめ母.json`のBOM（Byte Order Mark）エラー
- **状態**: 修正済み

### Gemini API Key未設定エラー
- **メッセージ**: `❌ GEMINI_API_KEY not found`
- **状態**: 正常動作（APIキー未設定時の正常な警告）

### 無効なモデル名エラー
- **動作**: 無効なモデル指定時はエラー表示（自動変換なし）
- **状態**: 意図した動作

### Geminiインスピレーション機能エラー
- **関連**: OpenRouter/Quota/JSON関連
- **状態**: 完全解決済み（14回目で根本解決）

### Claude Codeシステム問題
- **症状**: Claude Codeがクリア・コンパクト処理後に必ず同じビルドエラーに突撃する
- **状態**: システム的な繰り返し問題として認識

### ビルドエラー全般
- **関連**: OpenRouter API エラー、`Quota exceeded`、`JSON parsing`
- **状態**: 完全解決済み

### キャラクター読み込みエラー
- **症状**: 本番環境での文字化けと読み込み失敗
- **状態**: 修正済み

## 📝 修正反映確実性ルール

同じ問題が繰り返し発生する場合：

1. **3回ルール**: 同一修正を3回実行しても反映されない場合はシステム問題として認識
2. **完全検索確認**: 修正対象を`Grep`で全体検索し、すべての箇所を修正
3. **型システム優先**: `any`型アサーションではなく適切な型ガード使用
4. **修正済み機能保護**: API統合、インスピレーション等の既存機能の接続維持

## 🚨 緊急時の対応

### デバッグツールが使えない場合
ユーザー環境ではブラウザ開発者ツールが使用不可のため、以下の方法で対応：
- `console.log`を使用してログを出力
- ターミナルの出力を確認
- Reactの状態をUIに表示

### サーバーが応答しない場合
1. ポート3000のプロセスを確認
2. 必要に応じてプロセスを停止
3. .nextキャッシュをクリア
4. サーバーを再起動（時間がかかることを覚悟）

## 📞 サポート

問題が解決しない場合は、以下の情報を添えて報告してください：
- エラーメッセージ
- 再現手順
- 環境情報（OS、ブラウザ、Node.jsバージョン）
- 実施した対応内容
