# Claude Code 開発設定

## 必須参照ドキュメント

### 🎯 AI Chat V3 完全開発ガイド
- **ファイルパス**: `🎯 AI Chat V3 完全開発ガイド.md`
- **ルール**: 
  - 開発作業開始時に必ずこのドキュメントを読み込む
  - 機能追加・修正後は該当セクションを更新する
  - アーキテクチャ変更時は関連する図表も更新する

## 開発フロー

### 🚨 型安全開発フロー（必須遵守）
1. **型定義更新**: 新機能・変更前に`src/types/`の型定義を先に更新
2. **型検証**: `npx tsc --noEmit`でエラーがないことを確認
3. **機能実装**: TypeScriptエラーをガイドに実装
4. **継続検証**: 各変更後に再度`npx tsc --noEmit`実行
5. **ビルド確認**: `npm run build`で最終検証

### 基本開発フロー
1. 作業開始前: 完全開発ガイドを参照
2. 既存コードの理解: アーキテクチャと設計パターンを確認
3. 実装: ガイドに従った設計で実装
4. 完了後: ガイドドキュメントを最新状態に更新

### 型安全ルール（絶対遵守）
- **型ファーストアプローチ**: 新プロパティ使用前に型定義追加必須
- **unknown型禁止**: API応答は適切な型アサーション使用
- **継続的検証**: TypeScriptエラーを放置しない
- **原子的変更**: 1機能 = 1型更新 + 1実装のセット

## プロジェクト保護ルール（絶対遵守）

### 1. UI保護ルール
- **現在のUIアイコンを絶対変更しない**: 既存のアイコン、レイアウト、デザインを維持する
- **UI要素の削除禁止**: 現在実装されている機能のUI要素は削除しない  
- **既存インタラクション保護**: 現在の操作方法、ホバー効果、アニメーションを維持

### 2. 既存機能保護ルール  
- **既存機能への影響回避**: コードの変更は既存機能に影響を与えない範囲で実施
- **API互換性維持**: 既存のAPIインターフェース、データ構造を保持
- **状態管理の一貫性**: Zustandストア、コンテキストの既存構造を維持

### 🚨 Gemini API 重要ルール（絶対遵守）
- **フォールバック機能を絶対に追加しない**: Gemini APIのエラー時にOpenRouterへのフォールバックを作成しない
- **API関係でのフォールバック絶対禁止**: いかなるAPI関連処理においてもフォールバック機能を実装しない
- **エラーメッセージを明確に表示**: APIエラーは隠さず、ユーザーに原因を明確に伝える
- **対応モデル制限**: `gemini-2.5-flash`, `gemini-2.5-flash-light`, `gemini-2.5-pro` の3種類のみ**絶対遵守**
- **Gemini 2.5以外絶対書かない**: 上記3機種以外のモデル名は一切使用・記述・参照しない
- **自動変換・フォールバック禁止**: モデル名の自動変換や自動修正は一切行わない
- **OpenRouterでGemini 2.5は使用可能**: OpenRouterは`google/gemini-2.5-flash`等をサポート（公式サイトで確認済み）
- **解決済みエラー**: OpenRouter API エラー、`Quota exceeded`、`JSON parsing`問題は完全解決済み

### 3. 設定永続化の確実性
- **設定が勝手に変更されることを防ぐ**: モデル設定、プロンプト設定等の自動変更を禁止
- **永続化の検証**: 設定変更後は必ず永続化が正しく動作することを確認
- **デフォルト値の慎重な設定**: デフォルト値変更時は既存ユーザーへの影響を考慮

### 4. デプロイ前必須チェック
- **根本調査の実施**: 反復修正エラーを防ぐため、問題の根本原因を必ず特定
- **既存機能の動作確認**: すべての主要機能が正常動作することを確認
- **設定保存・読み込みテスト**: 設定の永続化が正しく機能することを確認
- **画像・動画アップロード確認**: ファイル選択→アップロード→プレビュー表示が正常動作することを確認
- **システムプロンプト永続化確認**: カスタムプロンプト設定→保存→ページリロード→設定維持を確認
- **UI/UX破綻チェック**: レイアウト、アニメーション、レスポンシブ対応を確認
- **モバイル最適化確認**: タッチ操作、画面サイズ、Safe Area対応を確認

## 開発サーバー運用ルール（重要）

### 🔄 Claude Code処理後の必須対処（重要）
- **問題**: Claude Codeのクリア・コンパクト処理後に必ず同じビルドエラーが発生
- **対策**: Claude Codeが何らかの自動処理を実行した後は、必ず以下を確認
  1. ビルドエラーが発生していないかチェック
  2. エラー発生時は即座に既知の修正パターンを適用
  3. 根本原因はClaude Codeのシステム処理にあることを認識

### 5. 開発サーバー制約
- **ポート3000固定**: ユーザー環境では3000以外のポートでサーバー起動禁止
- **サーバー停止厳禁**: 一度サーバーを停止すると再起動に非常に長い時間を要するため、必要時以外はサーバーを停止しない
- **サーバー起動前確認**: 必ず既存プロセスの確認と停止を実施
- **デバッグツール制約**: ユーザー環境ではブラウザ開発者ツールが使用不可
- **サーバー再起動時間**: .nextキャッシュクリアによる再起動は相当な時間を要する
- **エラー時の対処**: サーバーエラー発生時は即座にプロセス停止し、キャッシュクリア後に再起動
- **Hot Reload優先**: コード修正はHot Reloadで反映させ、可能な限りサーバーを停止しない

### サーバー運用コマンド
```bash
# プロセス確認
netstat -ano | findstr :3000

# プロセス停止
powershell "Stop-Process -Id [PID] -Force"

# キャッシュクリア＆再起動
powershell "Remove-Item -Recurse -Force .next -ErrorAction SilentlyContinue"
npm run dev
```

## 🔒 永続化保護ルール（絶対遵守）

### データ永続化の厳守事項
- **LocalStorage破壊禁止**: ブラウザのLocalStorageを消去・リセットする処理を絶対に追加しない
- **セッション永続化**: チャット履歴は必ずsrc/store/index.tsのpersist設定に含める
- **設定値保護**: API設定、プロンプト設定、UI設定などすべての設定値を永続化対象に含める
- **キャッシュ機能追加禁止**: インスピレーション機能など既存機能に新たなキャッシュを追加しない
- **再生成ボタン保護**: メッセージ再生成、続き生成などのボタン機能を削除・無効化しない

### 変更禁止項目リスト
- **インスピレーション再生成ボタン**: 削除・無効化禁止
- **チャット履歴の永続化設定**: sessionsは必ずpartializeに含める
- **記憶システム設定**: memoryCards、memoryLayersの永続化を維持
- **API設定**: apiConfig、各種APIキーの永続化を維持
- **UI設定**: 背景設定、効果設定などの永続化を維持

## その他の設定

- TypeScript strict モード使用
- ESLint/Prettier による自動フォーマット
- Git コミット前の必須チェック項目

## よくある問題と短縮入力

### 🔧 既知のビルドエラー対応（修正済み・心配不要）
- **BOMエラー**: `kusuguri.json`と`いじめ母.json`のBOM（Byte Order Mark）エラー → **修正済み**
- **Gemini API Key未設定エラー**: `❌ GEMINI_API_KEY not found` → **正常動作（APIキー未設定時の正常な警告）**
- **無効なモデル名エラー**: 無効なモデル指定時はエラー表示（自動変換なし）
- **Geminiインスピレーション機能エラー**: OpenRouter/Quota/JSON関連 → **完全解決済み（14回目で根本解決）**
- **Claude Codeシステム問題**: Claude Codeがクリア・コンパクト処理後に必ず同じビルドエラーに突撃する → **システム的な繰り返し問題として認識**
- **ビルドエラー全般**: OpenRouter API エラー、`Quota exceeded`、`JSON parsing` → **完全解決済み**
- **キャラクター読み込みエラー**: 本番環境での文字化けと読み込み失敗 → **修正済み**

## 🔒 **重要な修正ルール（絶対遵守）**

### **🚨 Character型とPersona型の保護ルール**
- **avatar_url完全削除**: キャラクター・ペルソナ型から`avatar_url`プロパティは永続的に削除
- **Character型準拠**: 必ず`Character,User Persona Type Definitive Format.md`に完全準拠
- **background_url使用**: 画像表示が必要な場合は`background_url`を使用
- **型定義一貫性**: Character/Persona型の変更は全関連ファイルに反映必須

### **🚨 API設定保護ルール（絶対遵守）**
- **Geminiデフォルト絶対禁止**: `provider: "gemini"`をデフォルト設定に使用禁止
- **ユーザー選択モデル優先**: 設定されたモデル・プロバイダーのみ使用
- **デフォルトプロバイダー**: `openrouter`を基本デフォルトとする
- **自動フォールバック禁止**: GeminiエラーでのOpenRouterフォールバック作成禁止

### **🔧 修正反映確実性ルール**
- **3回ルール**: 同一修正を3回実行しても反映されない場合はシステム問題として認識
- **完全検索確認**: 修正対象を`Grep`で全体検索し、すべての箇所を修正
- **型システム優先**: `any`型アサーションではなく適切な型ガード使用
- **修正済み機能保護**: API統合、インスピレーション等の既存機能の接続維持

### チャット機能の不具合対応
- **短縮入力**: 「チャット見てください」
- **問題**: メニュー非表示、再生成・続き生成が反応しない、チャットメニューが消える
- **原因**: 生成状態（is_generating/group_generating）が永続的にtrueになっている
- **自動修復**: 生成状態が30秒継続すると自動的にリセットされ、画面に通知表示
- **手動修復**: 
  1. **メッセージエリアをダブルクリック** →「✅ 生成状態をリセットしました」表示
  2. ページをリロード（F5）
  3. サーバー再起動（最終手段）