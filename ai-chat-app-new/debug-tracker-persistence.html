<!DOCTYPE html>
<html>
<head>
  <title>ãƒˆãƒ©ãƒƒã‚«ãƒ¼æ°¸ç¶šåŒ–ãƒ‡ãƒãƒƒã‚°</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #00ff00; }
    pre { background: #000; padding: 10px; overflow-x: auto; border: 1px solid #00ff00; }
    button { padding: 10px; margin: 5px; background: #00ff00; color: #000; border: none; cursor: pointer; }
    .error { color: #ff0000; }
    .success { color: #00ff00; }
    .warning { color: #ffaa00; }
  </style>
</head>
<body>
  <h1>ğŸ” ãƒˆãƒ©ãƒƒã‚«ãƒ¼æ°¸ç¶šåŒ–ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</h1>

  <button onclick="checkStorage()">LocalStorageç¢ºèª</button>
  <button onclick="checkTrackerManagers()">TrackerManagersç¢ºèª</button>
  <button onclick="clearStorage()">LocalStorageã‚¯ãƒªã‚¢</button>

  <h2>çµæœ:</h2>
  <pre id="output"></pre>

  <script>
    function log(message, type = 'normal') {
      const output = document.getElementById('output');
      const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
      output.innerHTML += `<span class="${className}">${message}</span>\n`;
    }

    function checkStorage() {
      document.getElementById('output').innerHTML = '';
      log('=== LocalStorageç¢ºèª ===', 'success');

      const storageKey = 'ai-chat-v3-storage';
      const data = localStorage.getItem(storageKey);

      if (!data) {
        log('âŒ LocalStorageã«ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“', 'error');
        return;
      }

      log(`âœ… ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º: ${(data.length / 1024).toFixed(2)}KB`, 'success');

      try {
        const parsed = JSON.parse(data);
        log(`âœ… JSONè§£ææˆåŠŸ`, 'success');

        if (parsed.state) {
          log(`âœ… stateå­˜åœ¨: ${Object.keys(parsed.state).length}å€‹ã®ã‚­ãƒ¼`, 'success');

          // trackerManagersç¢ºèª
          if (parsed.state.trackerManagers) {
            log(`âœ… trackerManagerså­˜åœ¨`, 'success');
            log(`   ã‚¿ã‚¤ãƒ—: ${parsed.state.trackerManagers._type || 'unknown'}`, 'warning');

            if (parsed.state.trackerManagers._type === 'map' && parsed.state.trackerManagers.value) {
              const entries = parsed.state.trackerManagers.value;
              log(`   ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ•°: ${entries.length}`, 'success');

              entries.forEach(([sessionId, manager], index) => {
                log(`\n   [${index}] SessionID: ${sessionId.substring(0, 20)}...`, 'warning');

                if (manager && manager._type === 'TrackerManager') {
                  log(`       âœ… TrackerManagerå½¢å¼`, 'success');

                  if (manager.value && manager.value.trackerSets) {
                    const trackerSetKeys = Object.keys(manager.value.trackerSets);
                    log(`       TrackerSets: ${trackerSetKeys.length}å€‹`, 'success');

                    trackerSetKeys.forEach(characterId => {
                      const trackerSet = manager.value.trackerSets[characterId];
                      log(`\n         CharacterID: ${characterId.substring(0, 20)}...`, 'warning');

                      if (trackerSet.trackers) {
                        if (Array.isArray(trackerSet.trackers)) {
                          log(`           âœ… trackersé…åˆ—: ${trackerSet.trackers.length}å€‹`, 'success');

                          trackerSet.trackers.slice(0, 3).forEach(([name, tracker]) => {
                            log(`             - ${name}: ${tracker.current_value}`, 'normal');
                          });

                          if (trackerSet.trackers.length > 3) {
                            log(`             ... ä»–${trackerSet.trackers.length - 3}å€‹`, 'normal');
                          }
                        } else {
                          log(`           âŒ trackerså½¢å¼ã‚¨ãƒ©ãƒ¼: ${typeof trackerSet.trackers}`, 'error');
                        }
                      } else {
                        log(`           âŒ trackersãŒå­˜åœ¨ã—ã¾ã›ã‚“`, 'error');
                      }
                    });
                  } else {
                    log(`       âŒ trackerSetsãŒå­˜åœ¨ã—ã¾ã›ã‚“`, 'error');
                  }
                } else {
                  log(`       âŒ TrackerManagerå½¢å¼ã‚¨ãƒ©ãƒ¼`, 'error');
                  log(`       å®Ÿéš›ã®å‹: ${manager?._type || typeof manager}`, 'error');
                }
              });
            } else {
              log(`   âŒ trackerManagers.valueãŒå­˜åœ¨ã—ãªã„ã‹å½¢å¼ã‚¨ãƒ©ãƒ¼`, 'error');
            }
          } else {
            log(`âŒ trackerManagersãŒå­˜åœ¨ã—ã¾ã›ã‚“`, 'error');
          }
        } else {
          log(`âŒ stateãŒå­˜åœ¨ã—ã¾ã›ã‚“`, 'error');
        }

        log(`\n=== å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿æ§‹é€ ï¼ˆæœ€åˆã®2000æ–‡å­—ï¼‰ ===`, 'warning');
        log(JSON.stringify(parsed, null, 2).substring(0, 2000) + '...');

      } catch (error) {
        log(`âŒ JSONè§£æã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
      }
    }

    function checkTrackerManagers() {
      document.getElementById('output').innerHTML = '';
      log('=== TrackerManagersï¼ˆãƒ©ãƒ³ã‚¿ã‚¤ãƒ ï¼‰ç¢ºèª ===', 'success');

      if (typeof window.useAppStore === 'undefined') {
        log('âŒ useAppStoreãŒå­˜åœ¨ã—ã¾ã›ã‚“ï¼ˆé–‹ç™ºã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ãªã„å¯èƒ½æ€§ï¼‰', 'error');
        return;
      }

      try {
        const state = window.useAppStore.getState();
        const trackerManagers = state.trackerManagers;

        if (trackerManagers instanceof Map) {
          log(`âœ… TrackerManagers: Map (${trackerManagers.size}å€‹)`, 'success');

          let index = 0;
          for (const [sessionId, manager] of trackerManagers.entries()) {
            log(`\n[${index}] SessionID: ${sessionId.substring(0, 20)}...`, 'warning');

            if (manager && typeof manager.getTrackerSet === 'function') {
              log(`  âœ… TrackerManagerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹`, 'success');

              // trackerSetsã‚’å–å¾—
              const trackerSetsObj = manager.getTrackerSetsAsObject ? manager.getTrackerSetsAsObject() : {};
              const characterIds = Object.keys(trackerSetsObj);

              log(`  TrackerSets: ${characterIds.length}å€‹`, 'success');

              characterIds.forEach(characterId => {
                const trackerSet = trackerSetsObj[characterId];
                log(`\n    CharacterID: ${characterId.substring(0, 20)}...`, 'warning');

                if (trackerSet.trackers && Array.isArray(trackerSet.trackers)) {
                  log(`      âœ… trackers: ${trackerSet.trackers.length}å€‹`, 'success');

                  trackerSet.trackers.slice(0, 3).forEach(([name, tracker]) => {
                    log(`        - ${name}: ${tracker.current_value}`, 'normal');
                  });

                  if (trackerSet.trackers.length > 3) {
                    log(`        ... ä»–${trackerSet.trackers.length - 3}å€‹`, 'normal');
                  }
                } else {
                  log(`      âŒ trackersãŒé…åˆ—ã§ã¯ãªã„`, 'error');
                }
              });
            } else {
              log(`  âŒ TrackerManagerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã¯ãªã„`, 'error');
              log(`  å‹: ${typeof manager}`, 'error');
            }

            index++;
          }
        } else {
          log(`âŒ trackerManagersãŒMapã§ã¯ãªã„: ${typeof trackerManagers}`, 'error');
        }
      } catch (error) {
        log(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        log(error.stack, 'error');
      }
    }

    function clearStorage() {
      if (confirm('LocalStorageã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
        localStorage.removeItem('ai-chat-v3-storage');
        document.getElementById('output').innerHTML = '';
        log('âœ… LocalStorageã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
      }
    }

    log('ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«æº–å‚™å®Œäº†', 'success');
    log('é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•å¾Œã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ç¢ºèªã—ã¦ãã ã•ã„', 'warning');
  </script>
</body>
</html>
