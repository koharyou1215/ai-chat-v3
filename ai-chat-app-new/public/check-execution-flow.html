<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®Ÿè¡Œãƒ•ãƒ­ãƒ¼ç¢ºèªãƒšãƒ¼ã‚¸</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background: #0f0f23;
      color: #fff;
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }
    h1 {
      color: #8b5cf6;
      border-bottom: 2px solid #8b5cf6;
      padding-bottom: 10px;
    }
    h2 {
      color: #ec4899;
      margin-top: 30px;
    }
    pre {
      background: #1e1e2e;
      border: 1px solid #374151;
      border-radius: 8px;
      padding: 15px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 400px;
      overflow-y: auto;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
    }
    .success {
      background: #10b981;
      color: #000;
    }
    .error {
      background: #ef4444;
      color: #fff;
    }
    .warning {
      background: #f59e0b;
      color: #000;
    }
    .info {
      background: #3b82f6;
      color: #fff;
    }
    button {
      background: #8b5cf6;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover {
      background: #7c3aed;
    }
    .code {
      background: #1e1e2e;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      color: #ec4899;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    table th,
    table td {
      border: 1px solid #374151;
      padding: 10px;
      text-align: left;
    }
    table th {
      background: #1e1e2e;
      color: #8b5cf6;
    }
    table tr:nth-child(even) {
      background: #1a1a2e;
    }
  </style>
</head>
<body>
  <h1>ğŸ” å®Ÿè¡Œãƒ•ãƒ­ãƒ¼ç¢ºèªãƒšãƒ¼ã‚¸</h1>

  <div>
    <button onclick="checkStoreState()">1. ã‚¹ãƒˆã‚¢çŠ¶æ…‹ã‚’ç¢ºèª</button>
    <button onclick="monitorConsoleLogs()">2. ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’ç›£è¦–</button>
    <button onclick="injectDebugCode()">3. ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ¼ãƒ‰ã‚’æ³¨å…¥</button>
    <button onclick="clearOutput()">å‡ºåŠ›ã‚’ã‚¯ãƒªã‚¢</button>
  </div>

  <div id="output"></div>

  <script>
    let originalConsoleLog = console.log;
    let capturedLogs = [];

    function log(message, type = 'info') {
      const output = document.getElementById('output');
      const div = document.createElement('div');
      div.className = `status ${type}`;
      div.innerHTML = message;
      output.appendChild(div);
    }

    function logJson(title, data) {
      const output = document.getElementById('output');
      const h2 = document.createElement('h2');
      h2.textContent = title;
      output.appendChild(h2);

      const pre = document.createElement('pre');
      pre.textContent = JSON.stringify(data, null, 2);
      output.appendChild(pre);
    }

    function logTable(title, data) {
      const output = document.getElementById('output');
      const h2 = document.createElement('h2');
      h2.textContent = title;
      output.appendChild(h2);

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');

      // Header
      const headerRow = document.createElement('tr');
      Object.keys(data[0] || {}).forEach(key => {
        const th = document.createElement('th');
        th.textContent = key;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);

      // Body
      data.forEach(row => {
        const tr = document.createElement('tr');
        Object.values(row).forEach(value => {
          const td = document.createElement('td');
          td.textContent = typeof value === 'object' ? JSON.stringify(value) : value;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      output.appendChild(table);
    }

    function clearOutput() {
      document.getElementById('output').innerHTML = '';
    }

    function checkStoreState() {
      clearOutput();
      log('='.repeat(80), 'info');
      log('ğŸ” Zustand ã‚¹ãƒˆã‚¢çŠ¶æ…‹ã®ç¢ºèª', 'info');
      log('='.repeat(80), 'info');

      try {
        // useAppStoreã®getStateãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦ã‚¹ãƒˆã‚¢ã«ã‚¢ã‚¯ã‚»ã‚¹
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        document.body.appendChild(iframe);

        // ãƒ¡ã‚¤ãƒ³ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«æˆ»ã£ã¦ç¢ºèª
        if (window.opener && window.opener.useAppStore) {
          const store = window.opener.useAppStore.getState();
          logJson('âœ… Zustand Store State', {
            chat: store.chat,
            is_generating: store.is_generating,
            active_session_id: store.active_session_id,
            sendProgressiveMessage: typeof store.sendProgressiveMessage,
            sendMessage: typeof store.sendMessage,
          });

          if (store.chat?.progressiveMode) {
            log('âœ… ãƒ—ãƒ­ã‚°ãƒ¬ãƒƒã‚·ãƒ–ãƒ¢ãƒ¼ãƒ‰è¨­å®š:', 'success');
            logTable('è¨­å®šè©³ç´°', [{
              enabled: store.chat.progressiveMode.enabled,
              showIndicators: store.chat.progressiveMode.showIndicators,
              highlightChanges: store.chat.progressiveMode.highlightChanges,
              glowIntensity: store.chat.progressiveMode.glowIntensity,
            }]);
          } else {
            log('âŒ ãƒ—ãƒ­ã‚°ãƒ¬ãƒƒã‚·ãƒ–ãƒ¢ãƒ¼ãƒ‰è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
          }

          if (typeof store.sendProgressiveMessage === 'function') {
            log('âœ… sendProgressiveMessage ãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã—ã¾ã™', 'success');
          } else {
            log('âŒ sendProgressiveMessage ãƒ¡ã‚½ãƒƒãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
          }
        } else {
          log('âš ï¸ ã“ã®ãƒšãƒ¼ã‚¸ã‹ã‚‰ç›´æ¥ã‚¹ãƒˆã‚¢ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“', 'warning');
          log('ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:', 'info');
          log('<pre>window.useAppStore.getState().chat.progressiveMode</pre>', 'info');
        }
      } catch (e) {
        log('âŒ ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
        log('ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œã—ã¦ãã ã•ã„:', 'warning');
        log('<pre>const state = window.useAppStore?.getState();\nconsole.log("chat.progressiveMode:", state?.chat?.progressiveMode);\nconsole.log("sendProgressiveMessage:", typeof state?.sendProgressiveMessage);</pre>', 'info');
      }
    }

    function monitorConsoleLogs() {
      clearOutput();
      log('='.repeat(80), 'info');
      log('ğŸ“Š ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ç›£è¦–é–‹å§‹', 'info');
      log('='.repeat(80), 'info');
      log('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¦ã€ä»¥ä¸‹ã®ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„:', 'info');

      log('', 'info');
      log('<strong>æœŸå¾…ã•ã‚Œã‚‹ãƒ­ã‚°:</strong>', 'info');
      log('1. <span class="code">ğŸ” Progressive Mode Check (Enhanced):</span>', 'info');
      log('2. <span class="code">ğŸš€ Using Progressive Message Generation</span> ã¾ãŸã¯ <span class="code">ğŸ“ Using Normal Message Generation</span>', 'info');
      log('3. <span class="code">ğŸš€ [sendProgressiveMessage] Method called</span> (ãƒ—ãƒ­ã‚°ãƒ¬ãƒƒã‚·ãƒ–ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ)', 'info');

      log('', 'info');
      log('<strong>ãƒ–ãƒ©ã‚¦ã‚¶ã®é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã‚’é–‹ã„ã¦ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¿ãƒ–ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</strong>', 'warning');
      log('F12ã‚­ãƒ¼ã‚’æŠ¼ã™ã¨é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ãŒé–‹ãã¾ã™ã€‚', 'info');

      log('', 'info');
      log('<strong>ç¢ºèªã™ã‚‹å€¤:</strong>', 'info');
      const checkItems = [
        { é …ç›®: 'chat', èª¬æ˜: 'chat ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å­˜åœ¨' },
        { é …ç›®: 'progressiveMode', èª¬æ˜: 'progressiveMode ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å­˜åœ¨' },
        { é …ç›®: 'enabled', èª¬æ˜: 'ãƒ—ãƒ­ã‚°ãƒ¬ãƒƒã‚·ãƒ–ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã‹ (true/false)' },
        { é …ç›®: 'enabledType', èª¬æ˜: 'enabled ã®å‹ (boolean ã§ã‚ã‚‹ã¹ã)' },
        { é …ç›®: 'is_group_mode', èª¬æ˜: 'ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰ã‹ (false ã§ã‚ã‚‹ã¹ã)' },
        { é …ç›®: 'should_use_progressive', èª¬æ˜: 'ãƒ—ãƒ­ã‚°ãƒ¬ãƒƒã‚·ãƒ–ã‚’ä½¿ç”¨ã™ã‚‹ã‹ (true ã§ã‚ã‚‹ã¹ã)' },
      ];
      logTable('ç¢ºèªé …ç›®', checkItems);

      // å®Ÿéš›ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
      console.log = function(...args) {
        originalConsoleLog.apply(console, args);
        const logMessage = args.map(arg =>
          typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
        ).join(' ');

        if (logMessage.includes('Progressive') || logMessage.includes('sendProgressiveMessage') || logMessage.includes('sendMessage')) {
          capturedLogs.push({
            timestamp: new Date().toISOString(),
            message: logMessage
          });

          // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è¡¨ç¤º
          const logDiv = document.createElement('div');
          logDiv.className = 'status info';
          logDiv.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${logMessage}`;
          document.getElementById('output').appendChild(logDiv);
        }
      };

      log('', 'success');
      log('âœ… ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¦ãã ã•ã„ã€‚', 'success');
    }

    function injectDebugCode() {
      clearOutput();
      log('='.repeat(80), 'info');
      log('ğŸ’‰ ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ¼ãƒ‰ã®æ³¨å…¥', 'info');
      log('='.repeat(80), 'info');

      log('ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆã—ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„:', 'warning');

      const debugCode = `
// ãƒ‡ãƒãƒƒã‚°ç”¨: ã‚¹ãƒˆã‚¢ã®çŠ¶æ…‹ã‚’ç¢ºèª
(function() {
  console.log("=".repeat(60));
  console.log("ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±");
  console.log("=".repeat(60));

  if (typeof window.useAppStore === 'undefined') {
    console.error("âŒ window.useAppStore ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    return;
  }

  const state = window.useAppStore.getState();

  console.log("1ï¸âƒ£ chatè¨­å®š:", state.chat);
  console.log("2ï¸âƒ£ progressiveMode:", state.chat?.progressiveMode);
  console.log("3ï¸âƒ£ enabled:", state.chat?.progressiveMode?.enabled);
  console.log("4ï¸âƒ£ enabled ã®å‹:", typeof state.chat?.progressiveMode?.enabled);
  console.log("5ï¸âƒ£ is_group_mode:", state.is_group_mode);
  console.log("6ï¸âƒ£ sendProgressiveMessage:", typeof state.sendProgressiveMessage);
  console.log("7ï¸âƒ£ sendMessage:", typeof state.sendMessage);

  const shouldUseProgressive = state.chat?.progressiveMode?.enabled === true && !state.is_group_mode;
  console.log("");
  console.log("ğŸ¯ åˆ¤å®šçµæœ:");
  console.log("  shouldUseProgressive:", shouldUseProgressive);
  console.log("  ç†ç”±:", !shouldUseProgressive ?
    (!state.chat?.progressiveMode?.enabled ? "ãƒ—ãƒ­ã‚°ãƒ¬ãƒƒã‚·ãƒ–ãƒ¢ãƒ¼ãƒ‰ãŒç„¡åŠ¹" : "ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¢ãƒ¼ãƒ‰") :
    "ãƒ—ãƒ­ã‚°ãƒ¬ãƒƒã‚·ãƒ–ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹");

  console.log("=".repeat(60));
})();
`;

      const pre = document.createElement('pre');
      pre.textContent = debugCode;
      pre.style.background = '#1e1e2e';
      pre.style.padding = '15px';
      pre.style.borderRadius = '8px';
      pre.style.cursor = 'pointer';
      pre.title = 'ã‚¯ãƒªãƒƒã‚¯ã§ã‚³ãƒ”ãƒ¼';
      pre.onclick = function() {
        navigator.clipboard.writeText(debugCode).then(() => {
          log('âœ… ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚', 'success');
        });
      };
      document.getElementById('output').appendChild(pre);

      log('', 'info');
      log('ğŸ‘† ä¸Šã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã™', 'info');
    }
  </script>
</body>
</html>
