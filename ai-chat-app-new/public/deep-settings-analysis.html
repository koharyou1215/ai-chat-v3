<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>è©³ç´°è¨­å®šåˆ†æ</title>
  <style>
    body { font-family: monospace; background: #0f0f23; color: #fff; padding: 20px; }
    pre { background: #1e1e2e; padding: 15px; border-radius: 8px; overflow-x: auto; }
    h1 { color: #8b5cf6; }
    h2 { color: #ec4899; margin-top: 30px; }
    .error { color: #ef4444; }
    .success { color: #10b981; }
    .warning { color: #f59e0b; }
    button { background: #8b5cf6; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
  </style>
</head>
<body>
  <h1>ğŸ”¬ è©³ç´°è¨­å®šåˆ†æ</h1>
  <button onclick="analyze()">åˆ†æé–‹å§‹</button>
  <button onclick="fixSettings()">è¨­å®šã‚’ä¿®æ­£</button>
  <div id="output"></div>
  
  <script>
    function analyze() {
      const output = document.getElementById('output');
      output.innerHTML = '';

      const log = (msg, type = '') => {
        const div = document.createElement('div');
        div.className = type;
        div.innerHTML = msg;
        output.appendChild(div);
      };

      const logJson = (title, data) => {
        const h2 = document.createElement('h2');
        h2.textContent = title;
        output.appendChild(h2);
        const pre = document.createElement('pre');
        pre.textContent = JSON.stringify(data, null, 2);
        output.appendChild(pre);
      };

      log('<h2>1ï¸âƒ£ LocalStorage ã® unified-settings</h2>');
      const unifiedStr = localStorage.getItem('unified-settings');
      if (unifiedStr) {
        try {
          const unified = JSON.parse(unifiedStr);
          logJson('unified-settings', {
            'chat.progressiveMode': unified.chat?.progressiveMode,
            'chatå…¨ä½“': unified.chat
          });

          if (unified.chat?.progressiveMode?.enabled === true) {
            log('âœ… unified-settings: ãƒ—ãƒ­ã‚°ãƒ¬ãƒƒã‚·ãƒ–ãƒ¢ãƒ¼ãƒ‰ã¯æœ‰åŠ¹', 'success');
          } else if (unified.chat?.progressiveMode?.enabled === false) {
            log('âŒ unified-settings: ãƒ—ãƒ­ã‚°ãƒ¬ãƒƒã‚·ãƒ–ãƒ¢ãƒ¼ãƒ‰ã¯ç„¡åŠ¹', 'error');
          } else {
            log('âš ï¸ unified-settings: ãƒ—ãƒ­ã‚°ãƒ¬ãƒƒã‚·ãƒ–ãƒ¢ãƒ¼ãƒ‰è¨­å®šãŒ undefined', 'warning');
            log('å®Ÿéš›ã®å€¤: ' + unified.chat?.progressiveMode?.enabled, 'warning');
          }
        } catch (e) {
          log('âŒ unified-settings ã®è§£æã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
        }
      } else {
        log('âŒ unified-settings ãŒå­˜åœ¨ã—ã¾ã›ã‚“', 'error');
      }

      log('<h2>2ï¸âƒ£ LocalStorage ã® ai-chat-v3-storage</h2>');
      const storeStr = localStorage.getItem('ai-chat-v3-storage');
      if (storeStr) {
        try {
          const store = JSON.parse(storeStr);
          logJson('ai-chat-v3-storage', {
            'state.chat.progressiveMode': store.state?.chat?.progressiveMode,
          });

          if (store.state?.chat?.progressiveMode?.enabled === true) {
            log('âœ… ai-chat-v3-storage: ãƒ—ãƒ­ã‚°ãƒ¬ãƒƒã‚·ãƒ–ãƒ¢ãƒ¼ãƒ‰ã¯æœ‰åŠ¹', 'success');
          } else if (store.state?.chat?.progressiveMode?.enabled === false) {
            log('âŒ ai-chat-v3-storage: ãƒ—ãƒ­ã‚°ãƒ¬ãƒƒã‚·ãƒ–ãƒ¢ãƒ¼ãƒ‰ã¯ç„¡åŠ¹', 'error');
          } else {
            log('âš ï¸ ai-chat-v3-storage: ãƒ—ãƒ­ã‚°ãƒ¬ãƒƒã‚·ãƒ–ãƒ¢ãƒ¼ãƒ‰è¨­å®šãŒ undefined', 'warning');
          }
        } catch (e) {
          log('âŒ ai-chat-v3-storage ã®è§£æã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
        }
      } else {
        log('âš ï¸ ai-chat-v3-storage ãŒå­˜åœ¨ã—ã¾ã›ã‚“', 'warning');
      }

      log('<h2>3ï¸âƒ£ å®Ÿè¡Œæ™‚ã®Zustandã‚¹ãƒˆã‚¢</h2>');
      log('ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:', 'warning');
      log('<pre>window.useAppStore?.getState().chat.progressiveMode</pre>');

      log('<h2>4ï¸âƒ£ ä¸æ•´åˆãƒã‚§ãƒƒã‚¯</h2>');
      if (unifiedStr && storeStr) {
        try {
          const unified = JSON.parse(unifiedStr);
          const store = JSON.parse(storeStr);
          const unifiedEnabled = unified.chat?.progressiveMode?.enabled;
          const storeEnabled = store.state?.chat?.progressiveMode?.enabled;

          if (unifiedEnabled !== storeEnabled) {
            log('âš ï¸ ä¸æ•´åˆæ¤œå‡ºï¼', 'warning');
            log(`unified-settings: ${unifiedEnabled}`, 'warning');
            log(`ai-chat-v3-storage: ${storeEnabled}`, 'warning');
            log('ã“ã‚ŒãŒåŸå› ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚', 'error');
          } else {
            log('âœ… unified-settings ã¨ ai-chat-v3-storage ã¯ä¸€è‡´ã—ã¦ã„ã¾ã™', 'success');
          }
        } catch (e) {
          log('ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
        }
      }
    }

    function fixSettings() {
      try {
        // unified-settings ã‚’ä¿®æ­£
        const unifiedStr = localStorage.getItem('unified-settings');
        if (unifiedStr) {
          const unified = JSON.parse(unifiedStr);
          if (!unified.chat) unified.chat = {};
          unified.chat.progressiveMode = {
            enabled: true,
            showIndicators: true,
            highlightChanges: true,
            glowIntensity: 'medium',
            stageDelays: {
              reflex: 0,
              context: 1000,
              intelligence: 2000,
            },
          };
          localStorage.setItem('unified-settings', JSON.stringify(unified));
          alert('âœ… unified-settings ã‚’ä¿®æ­£ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
        }

        // ai-chat-v3-storage ã¯ZustandãŒè‡ªå‹•ç®¡ç†ã™ã‚‹ãŸã‚ã€è§¦ã‚‰ãªã„
      } catch (e) {
        alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
    window.onload = analyze;
  </script>
</body>
</html>
